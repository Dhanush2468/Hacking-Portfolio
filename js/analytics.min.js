var loadStart = new Date().getTime();
var loadEnd;
var activityTimeout;
var ua = UAParser(navigator.userAgent);

function activityCheck() {
  if (window.self === window.top) {
    clearTimeout(activityTimeout);

    activityTimeout = setTimeout(function () {
      slickInsertAnalytics({
        type: "endsession",
      });
    }, 300000);
  }
}

function slickInsertAnalytics(data) {
  if (window.self === window.top && window.location.hostname !== "localhost") {
    data.domain = window.location.hostname.replace("www.", "");
    data.url =
      window.location.pathname + window.location.search + window.location.hash;
    data.referrer = document.referrer;
    data.user_language = navigator.language;
    data.user_agent = navigator.userAgent;
    data.os = ua.os.name;
    data.browser = ua.browser.name;
    data.browser_version = ua.browser.version;
    data.device_type = ua.device.type || "desktop";
    data.device_vendor = ua.device.vendor || null;
    data.device_model = ua.device.model || null;

    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/s/scripts/get-ip");
    xhr.onload = function () {
      var res = JSON.parse(this.response);

      if (res && res.status === "Success") {
        var ip = res.ip;

        if (ip !== "::1" && ip !== "127.0.0.1" && ip !== "localhost") {
          var xhr2 = new XMLHttpRequest();
          xhr2.open("GET", "https://ipapi.co/" + ip + "/json/");
          xhr2.onload = function () {
            var res = JSON.parse(this.response);

            if (res.city) {
              data.city = res.city;
              data.region = res.region;
              data.region_code = res.region_code;
              data.country = res.country_name;
              data.country_code = res.country_code_iso3;
              data.latitude = res.latitude;
              data.longitude = res.longitude;
            } else {
              console.warn("IP API Error");
            }

            var xhr3 = new XMLHttpRequest();
            xhr3.open("POST", "/s/scripts/analytics");
            xhr3.setRequestHeader("Content-Type", "application/json");
            xhr3.send(JSON.stringify(data));
          };
          xhr2.send();
        } else {
          var xhr3 = new XMLHttpRequest();
          xhr3.open("POST", "/s/scripts/analytics");
          xhr3.setRequestHeader("Content-Type", "application/json");
          xhr3.send(JSON.stringify(data));
        }
      } else {
        console.warn("Get IP Error");

        var xhr3 = new XMLHttpRequest();
        xhr3.open("POST", "/s/scripts/analytics");
        xhr3.setRequestHeader("Content-Type", "application/json");
        xhr3.send(JSON.stringify(data));
      }
    };
    xhr.send();
  }
}

function slickEvent(options) {
  if (window.self === window.top) {
    var data = {
      type: "event",
    };

    for (var key in options) {
      data[key] = options[key];
    }

    slickInsertAnalytics(data);
  }
}

function slickError(options) {
  if (window.self === window.top) {
    var data = {
      type: "error",
    };

    for (var key in options) {
      data[key] = options[key];
    }

    slickInsertAnalytics(data);
  }
}

window.addEventListener(
  "error",
  function (e) {
    if (window.self === window.top) {
      console.log("error: ", e);
    }
  },
  true
);

window.addEventListener("load", function (e) {
  if (window.self === window.top) {
    loadEnd = new Date().getTime();

    slickInsertAnalytics({
      type: "pageview",
      page_load: (loadEnd - loadStart) / 1000,
      duration: 0,
    });

    activityCheck();
  }
});

window.addEventListener("mousemove", activityCheck);
window.addEventListener("touchend", activityCheck);
window.addEventListener("keyup", activityCheck);
window.addEventListener("scroll", activityCheck);
